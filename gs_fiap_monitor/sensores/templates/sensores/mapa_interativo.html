{% extends 'sensores/base.html' %}
{% load static %}

{% block title %}Mapa Interativo de Monitoramento - Moskitto{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <header class="mb-12 text-center">
        <h1 class="text-4xl font-bold text-secondary">Mapa de Monitoramento em Tempo Real</h1>
        <p class="text-xl text-gray-600 mt-2">Visualize o status dos sensores e áreas de risco na cidade.</p>
    </header>

    <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-4">
            <aside class="lg:col-span-1 p-6 border-r border-gray-200 bg-gray-50">
                <h3 class="text-2xl font-bold text-secondary mb-6">Filtros e Controles</h3>
                
                <div class="mb-8">
                    <h4 class="font-bold text-gray-700 mb-3">Status do Dispositivo</h4>
                    <div class="space-y-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="critical" checked>
                            <span class="ml-2 text-gray-700">Crítico</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-alert"></span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="moderate" checked>
                            <span class="ml-2 text-gray-700">Moderado</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-yellow-400"></span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="normal" checked>
                            <span class="ml-2 text-gray-700">Normal</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-green-500"></span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h4 class="font-bold text-gray-700 mb-3">Regiões (Exemplo)</h4>
                    <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                        <option>Todas as Regiões</option>
                        <option>Centro</option>
                        <option>Zona Norte</option>
                        <option>Zona Sul</option>
                        <option>Zona Leste</option>
                        <option>Zona Oeste</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Funcionalidade de filtro por região a ser implementada.</p>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-700 mb-3">Legenda dos Marcadores</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <div class="map-marker critical">!</div>
                            <span class="ml-3 text-gray-700">Nível Crítico (&gt; 80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker moderate"></div>
                            <span class="ml-3 text-gray-700">Nível Moderado (51-80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker normal"></div>
                            <span class="ml-3 text-gray-700">Nível Normal (&le; 50%)</span>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="lg:col-span-3 h-[600px] md:h-[700px] relative">
                <div id="map" class="h-full w-full rounded-r-3xl"></div>
            </main>
        </div>
    </div>

    <div class="mt-12 text-center">
        <a href="{% url 'home_page' %}" class="text-primary hover:text-blue-700 font-medium px-4 py-2 rounded border border-primary hover:bg-primary hover:text-white transition-colors">&larr; Voltar para a Home Page</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ dispositivos_map_data|json_script:"dispositivos-map-data-json" }}

<script>
    let map;
    let allMapMarkers = []; // Para guardar referência a todos os marcadores

    function initMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error("Elemento do mapa não encontrado!");
            return;
        }

        let initialLat = -23.550520;
        let initialLng = -46.633308;
        let initialZoom = 10;

        const dispositivosDataElement = document.getElementById('dispositivos-map-data-json');
        let dispositivos = [];
        if (dispositivosDataElement) {
            try {
                dispositivos = JSON.parse(dispositivosDataElement.textContent);
                console.log('[DEBUG] Dispositivos recebidos para o mapa:', dispositivos);
            } catch (e) {
                console.error("Erro ao parsear dados dos dispositivos:", e);
            }
        }

        map = L.map('map').setView([initialLat, initialLng], initialZoom);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        renderMarkers(dispositivos); // Chama a função para renderizar marcadores

        // Ajusta o mapa para mostrar todos os dispositivos
        const bounds = [];
        dispositivos.forEach(d => {
            if (typeof d.latitude === 'number' && typeof d.longitude === 'number') {
                bounds.push([d.latitude, d.longitude]);
            }
        });
        if (bounds.length > 0) {
            map.fitBounds(bounds, {padding: [40, 40]});
        }

        // Adiciona listeners para os checkboxes de filtro
        document.querySelectorAll('.filter-status').forEach(checkbox => {
            checkbox.addEventListener('change', filterMarkersByStatus);
        });
    }

    function renderMarkers(dispositivosList) {
        // Limpa marcadores existentes
        allMapMarkers.forEach(marker => map.removeLayer(marker));
        allMapMarkers = [];

        dispositivosList.forEach(disp => {
            if (typeof disp.latitude !== 'number' || typeof disp.longitude !== 'number') {
                console.warn(`[DEBUG] Dispositivo '${disp.nome}' (ID: ${disp.id}) sem coordenadas válidas.`, disp);
                return;
            }
            console.log(`[DEBUG] Renderizando marcador: ${disp.nome} | Status: ${disp.status} | Lat: ${disp.latitude} | Lng: ${disp.longitude}`);

            // A lógica de status já vem da view agora em disp.status
            const status = disp.status || 'normal';

            const iconClasses = `map-marker ${status}`; // As classes CSS já devem estar no base.html ou aqui
            const markerElement = L.divIcon({
                className: iconClasses,
                html: `<span class='pulse-inner'>${status === 'critical' ? '!' : ''}</span>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16] // Centraliza o círculo do marcador
            });
            
            let statusLabel = status === 'critical' ? 'Crítico' : status === 'moderate' ? 'Moderado' : 'Normal';
            let popupContent = `<b>${disp.nome}</b> (ID: ${disp.id})<br>${disp.descricao || ''}`;
            if (disp.leituras) {
                for (const sensorNome in disp.leituras) {
                    const leitura = disp.leituras[sensorNome];
                    popupContent += `<br>${sensorNome}: ${leitura.valor} ${leitura.unidade} (${leitura.timestamp})`;
                }
            }
            popupContent += `<br><b>Status:</b> <span class="status-popup-${status}">${statusLabel}</span>`;

            const leafletMarker = L.marker([disp.latitude, disp.longitude], {icon: markerElement, deviceStatus: status}) // Adiciona status ao marcador
                .addTo(map)
                .bindPopup(popupContent);
            allMapMarkers.push(leafletMarker);
        });
    }

    function filterMarkersByStatus() {
        const activeStatuses = [];
        document.querySelectorAll('.filter-status:checked').forEach(checkbox => {
            activeStatuses.push(checkbox.value);
        });

        allMapMarkers.forEach(marker => {
            if (activeStatuses.includes(marker.options.deviceStatus)) {
                if (!map.hasLayer(marker)) {
                    map.addLayer(marker);
                }
            } else {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        // Outros scripts específicos para esta página podem ir aqui
    });
</script>
<style>
    /* Adicionando estilos para os popups de status para garantir visibilidade */
    .status-popup-critical { color: red; font-weight: bold; }
    .status-popup-moderate { color: orange; font-weight: bold; }
    .status-popup-normal { color: green; font-weight: bold; }
    .map-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border: 2px solid #fff;
        position: relative;
        z-index: 10;
        box-sizing: border-box;
        display: block;
        text-align: center;
        line-height: 32px;
        padding: 0;
        margin: 0;
        /* Remover qualquer transition/transform daqui! */
    }
    .pulse-inner {
        display: inline-block;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        line-height: 32px;
        text-align: center;
    }
    .critical .pulse-inner {
        background-color: #ff4d4d;
        animation: critical-pulse 1.5s infinite;
    }
    .moderate .pulse-inner {
        background-color: #facc15;
    }
    .normal .pulse-inner {
        background-color: #22c55e;
    }
    @keyframes critical-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255,77,77,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255,77,77,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,77,77,0); }
    }
</style>
{% endblock %} 