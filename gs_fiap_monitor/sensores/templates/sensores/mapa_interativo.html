{% extends 'sensores/base.html' %}
{% load static %}

{% block title %}Mapa Interativo de Monitoramento - Moskitto{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <header class="mb-12 text-center">
        <h1 class="text-4xl font-bold text-secondary">Mapa de Monitoramento em Tempo Real</h1>
        <p class="text-xl text-gray-600 mt-2">Visualize o status dos sensores e áreas de risco na cidade.</p>
    </header>

    <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-4">
            <aside class="lg:col-span-1 p-6 border-r border-gray-200 bg-gray-50">
                <h3 class="text-2xl font-bold text-secondary mb-6">Filtros e Controles</h3>
                
                <div class="mb-8">
                    <h4 class="font-bold text-gray-700 mb-3">Status do Dispositivo</h4>
                    <div class="space-y-2">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="critical" checked>
                            <span class="ml-2 text-gray-700">Crítico</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-alert"></span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="moderate" checked>
                            <span class="ml-2 text-gray-700">Moderado</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-yellow-400"></span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-primary rounded focus:ring-primary-darker filter-status" value="normal" checked>
                            <span class="ml-2 text-gray-700">Normal</span>
                            <span class="ml-auto w-4 h-4 rounded-full bg-green-500"></span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-700 mb-3">Legenda dos Marcadores</h4>
                    <div class="space-y-3">
                        <div class="flex items-center">
                            <div class="map-marker critical">!</div>
                            <span class="ml-3 text-gray-700">Nível Crítico (&gt; 80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker moderate"></div>
                            <span class="ml-3 text-gray-700">Nível Moderado (51-80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker normal"></div>
                            <span class="ml-3 text-gray-700">Nível Normal (&le; 50%)</span>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="lg:col-span-3 h-[600px] md:h-[700px] relative">
                <div id="map" class="h-full w-full rounded-r-3xl"></div>
            </main>
        </div>
    </div>

    <div class="mt-12 text-center">
        <a href="{% url 'home_page' %}" class="text-primary hover:text-blue-700 font-medium px-4 py-2 rounded border border-primary hover:bg-primary hover:text-white transition-colors">&larr; Voltar para a Home Page</a>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ dispositivos_map_data|json_script:"dispositivos-map-data-json" }}

<script>
    let map;
    let allMapMarkers = [];

    function initMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error("Elemento do mapa não encontrado!");
            return;
        }

        let initialLat = -23.550520;
        let initialLng = -46.633308;
        let initialZoom = 10;

        const dispositivosDataElement = document.getElementById('dispositivos-map-data-json');
        let dispositivos = [];
        if (dispositivosDataElement) {
            try {
                dispositivos = JSON.parse(dispositivosDataElement.textContent);
            } catch (e) {
                console.error("Erro ao parsear dados dos dispositivos:", e);
            }
        }

        map = L.map('map').setView([initialLat, initialLng], initialZoom);
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });
        tileLayer.addTo(map);

        renderMarkers(dispositivos);

        const bounds = [];
        dispositivos.forEach(d => {
            if (typeof d.latitude === 'number' && typeof d.longitude === 'number') {
                bounds.push([d.latitude, d.longitude]);
            }
        });
        if (bounds.length > 0) {
            map.fitBounds(bounds, {padding: [40, 40]});
        }

        document.querySelectorAll('.filter-status').forEach(checkbox => {
            checkbox.addEventListener('change', filterMarkersByStatus);
        });
    }

    function renderMarkers(dispositivosList) {
        allMapMarkers.forEach(marker => map.removeLayer(marker));
        allMapMarkers = [];

        dispositivosList.forEach(disp => {
            if (typeof disp.latitude !== 'number' || typeof disp.longitude !== 'number') {
                return;
            }
            const statusClass = disp.status_marcador || 'normal';
            const iconClasses = `map-marker ${statusClass}`;
            const markerElement = L.divIcon({
                className: iconClasses,
                html: `<span class='pulse-inner'>${statusClass === 'critical' ? '!' : ''}</span>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            let statusNivelAguaLabel = disp.status_marcador === 'critical' ? 'Crítico' :
                                   disp.status_marcador === 'moderate' ? 'Moderado' : 'Normal';

            let leiturasHtml = '';
            if (disp.leituras_formatadas && Object.keys(disp.leituras_formatadas).length > 0) {
                leiturasHtml = Object.entries(disp.leituras_formatadas).map(([sensor, leitura]) => {
                    return `<p class="text-xs text-gray-700 leading-tight"><strong class="font-medium">${sensor}:</strong> ${leitura}</p>`;
                }).join('');
            } else {
                leiturasHtml = '<p class="text-xs text-gray-500 italic">Nenhuma leitura registrada.</p>';
            }

            const popupContent = `
                <div class="map-popup-content text-sm text-gray-800" style="min-width: 230px; max-width:280px;">
                    <h3 class="text-base font-bold text-secondary mb-0.5">${disp.nome}</h3>
                    <p class="text-xs text-gray-500 mb-1.5 leading-tight">ID: ${disp.id}<br>${disp.descricao}</p>
                    <div class="mb-2 text-xs leading-tight">
                        <strong class="font-medium">Nível Água:</strong> 
                        <span class="font-semibold px-1.5 py-0.5 rounded-full text-white text-[10px] 
                            ${disp.status_marcador === 'critical' ? 'bg-red-500' : disp.status_marcador === 'moderate' ? 'bg-yellow-500' : 'bg-green-500'}">
                            ${statusNivelAguaLabel}
                        </span><br>
                        <strong class="font-medium">Operacional:</strong> 
                        <span class="font-semibold ${disp.status_operacional === 'Online' ? 'text-green-600' : 'text-red-600'}">
                            ${disp.status_operacional}
                        </span>
                    </div>
                    <div class="border-t border-gray-200 pt-1.5 mt-1.5">
                        <h4 class="text-xs font-semibold text-gray-600 mb-0.5">Últimas Leituras:</h4>
                        ${leiturasHtml}
                    </div>
                    ${disp.url_detalhes !== '#' ? 
                        `<div class="mt-2 pt-1 border-t border-gray-200 text-right">
                            <a href="${disp.url_detalhes}" class="text-xs text-blue-600 hover:text-blue-800 hover:underline font-medium">Ver Detalhes &rarr;</a>
                         </div>` : ''}
                </div>
            `;

            const leafletMarker = L.marker([disp.latitude, disp.longitude], {icon: markerElement, deviceStatus: disp.status_marcador})
                .addTo(map)
                .bindPopup(popupContent);
            
            allMapMarkers.push(leafletMarker);
        });
    }

    function filterMarkersByStatus() {
        const activeStatuses = [];
        document.querySelectorAll('.filter-status:checked').forEach(checkbox => {
            activeStatuses.push(checkbox.value);
        });

        allMapMarkers.forEach(marker => {
            if (activeStatuses.includes(marker.options.deviceStatus)) {
                if (!map.hasLayer(marker)) {
                    map.addLayer(marker);
                }
            } else {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
    });
</script>
<style>
    /* Adicionando estilos para os popups de status para garantir visibilidade */
    .status-popup-critical { color: red; font-weight: bold; }
    .status-popup-moderate { color: orange; font-weight: bold; }
    .status-popup-normal { color: green; font-weight: bold; }
    .map-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border: 2px solid #fff;
        position: relative;
        z-index: 10;
        box-sizing: border-box;
        display: block;
        text-align: center;
        line-height: 32px;
        padding: 0;
        margin: 0;
        /* Remover qualquer transition/transform daqui! */
    }
    .pulse-inner {
        display: inline-block;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        line-height: 32px;
        text-align: center;
    }
    .critical .pulse-inner {
        background-color: #ff4d4d;
        animation: critical-pulse 1.5s infinite;
    }
    .moderate .pulse-inner {
        background-color: #facc15;
    }
    .normal .pulse-inner {
        background-color: #22c55e;
    }
    @keyframes critical-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255,77,77,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255,77,77,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,77,77,0); }
    }
    /* Tema dark via CSS para o mapa (DEV.to) */
    .leaflet-tile {
        filter: invert(90%) hue-rotate(180deg);
    }
    .leaflet-container {
        background: #111;
    }
    /* Remove filtro dos controles, marcadores e overlays */
    .leaflet-control,
    .leaflet-marker-icon,
    .leaflet-pane > *:not(.leaflet-tile) {
        filter: none !important;
    }

    /* Adicionar um z-index mais alto para o popup do Leaflet para ficar sobre o overlay do modal quando o modal está fechado */
    .leaflet-popup-pane {
        z-index: 650; /* Menor que o modal (1000), mas acima de outros elementos */
    }
</style>
{% endblock %} 