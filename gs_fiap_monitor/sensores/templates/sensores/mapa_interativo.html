{% extends 'sensores/base.html' %}
{% load static %}

{% block title %}Mapa Interativo de Monitoramento - Moskitto{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <header class="mb-8 sm:mb-12 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-secondary">Mapa de Monitoramento em Tempo Real</h1>
        <p class="text-lg sm:text-xl text-gray-600 mt-2">Visualize o status dos sensores e áreas de risco na cidade.</p>
    </header>

    <div class="bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-4">
            <aside class="lg:col-span-1 p-4 sm:p-6 border-b lg:border-b-0 lg:border-r border-gray-200 bg-gray-50">
                <h3 class="text-xl sm:text-2xl font-bold text-secondary mb-4 sm:mb-6">Filtros e Controles</h3>
                
                <div class="mb-6 sm:mb-8">
                    <h4 class="font-bold text-gray-700 mb-2 sm:mb-3 text-sm sm:text-base">Status do Dispositivo</h4>
                    <div class="space-y-2">
                        <label class="flex items-center cursor-pointer text-sm sm:text-base">
                            <input type="checkbox" class="form-checkbox h-4 w-4 sm:h-5 sm:w-5 text-primary rounded focus:ring-primary-darker filter-status" value="critical" checked>
                            <span class="ml-2 text-gray-700">Crítico</span>
                            <span class="ml-auto w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-alert"></span>
                        </label>
                        <label class="flex items-center cursor-pointer text-sm sm:text-base">
                            <input type="checkbox" class="form-checkbox h-4 w-4 sm:h-5 sm:w-5 text-primary rounded focus:ring-primary-darker filter-status" value="moderate" checked>
                            <span class="ml-2 text-gray-700">Moderado</span>
                            <span class="ml-auto w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-yellow-400"></span>
                        </label>
                        <label class="flex items-center cursor-pointer text-sm sm:text-base">
                            <input type="checkbox" class="form-checkbox h-4 w-4 sm:h-5 sm:w-5 text-primary rounded focus:ring-primary-darker filter-status" value="normal" checked>
                            <span class="ml-2 text-gray-700">Normal</span>
                            <span class="ml-auto w-3 h-3 sm:w-4 sm:h-4 rounded-full bg-green-500"></span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-700 mb-2 sm:mb-3 text-sm sm:text-base">Legenda dos Marcadores</h4>
                    <div class="space-y-2 sm:space-y-3 text-sm sm:text-base">
                        <div class="flex items-center">
                            <div class="map-marker critical text-xs sm:text-sm w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center">!</div>
                            <span class="ml-2 sm:ml-3 text-gray-700">Nível Crítico (&gt; 80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker moderate text-xs sm:text-sm w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center"></div>
                            <span class="ml-2 sm:ml-3 text-gray-700">Nível Moderado (51-80%)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="map-marker normal text-xs sm:text-sm w-6 h-6 sm:w-7 sm:h-7 flex items-center justify-center"></div>
                            <span class="ml-2 sm:ml-3 text-gray-700">Nível Normal (&le; 50%)</span>
                        </div>
                    </div>
                </div>
            </aside>
            
            <main class="lg:col-span-3 h-[50vh] sm:h-[60vh] md:h-[70vh] lg:h-[calc(100vh-200px)] min-h-[400px] relative">
                <div id="map" class="h-full w-full lg:rounded-r-3xl"></div>
            </main>
        </div>
    </div>

    <div class="mt-8 sm:mt-12 text-center">
        <a href="{% url 'home_page' %}" class="text-sm sm:text-base text-primary hover:text-blue-700 font-medium px-3 py-1.5 sm:px-4 sm:py-2 rounded border border-primary hover:bg-primary hover:text-white transition-colors">&larr; Voltar para a Home Page</a>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
{{ dispositivos_map_data|json_script:"dispositivos-map-data-json" }}

<script>
    let map;
    let allMapMarkers = [];

    function initMap() {
        const mapElement = document.getElementById('map');
        if (!mapElement) {
            console.error("Elemento do mapa não encontrado!");
            return;
        }

        let initialLat = -23.550520;
        let initialLng = -46.633308;
        let initialZoom = 10;

        const dispositivosDataElement = document.getElementById('dispositivos-map-data-json');
        let dispositivos = [];
        if (dispositivosDataElement) {
            try {
                dispositivos = JSON.parse(dispositivosDataElement.textContent);
            } catch (e) {
                console.error("Erro ao parsear dados dos dispositivos:", e);
            }
        }

        map = L.map('map').setView([initialLat, initialLng], initialZoom);
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });
        tileLayer.addTo(map);

        renderMarkers(dispositivos);

        const bounds = [];
        dispositivos.forEach(d => {
            if (typeof d.latitude === 'number' && typeof d.longitude === 'number') {
                bounds.push([d.latitude, d.longitude]);
            }
        });
        if (bounds.length > 0) {
            map.fitBounds(bounds, {padding: [40, 40]});
        }

        document.querySelectorAll('.filter-status').forEach(checkbox => {
            checkbox.addEventListener('change', filterMarkersByStatus);
        });
    }

    function renderMarkers(dispositivosList) {
        allMapMarkers.forEach(marker => map.removeLayer(marker));
        allMapMarkers = [];

        // Helper para formatar timestamp (America/Sao_Paulo)
        const formatTimestampSP = (dateString) => {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleTimeString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', timeZone: 'America/Sao_Paulo' });
            } catch (e) {
                console.warn('Erro formatando data para SP:', dateString, e);
                return dateString; // fallback
            }
        };

        dispositivosList.forEach(disp => {
            if (typeof disp.latitude !== 'number' || typeof disp.longitude !== 'number') {
                return;
            }
            const statusClass = disp.status_marcador_code || 'normal'; // Usar o _code para a classe do marcador
            const iconClasses = `map-marker ${statusClass}`;
            const markerElement = L.divIcon({
                className: iconClasses,
                html: `<span class='pulse-inner'>${statusClass === 'critical' ? '!' : ''}</span>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            
            // --- Construção do HTML do Popup ---
            let statusBadgeHtml = '';
            let statusIconClass = 'fas fa-check-circle';
            let statusBgColor = 'bg-green-500';

            if (disp.status_nivel_agua_texto === 'Crítico') {
                statusIconClass = 'fas fa-exclamation-triangle';
                statusBgColor = 'bg-red-500';
            } else if (disp.status_nivel_agua_texto === 'Moderado') {
                statusIconClass = 'fas fa-exclamation-circle';
                statusBgColor = 'bg-yellow-500';
            }
            statusBadgeHtml = `<span class="mt-1 inline-flex items-center px-2 py-0.5 text-xs font-semibold ${statusBgColor} text-white rounded-full capitalize"><i class="${statusIconClass} mr-1.5"></i>${disp.status_nivel_agua_texto || 'Indefinido'}</span>`;

            const statusAdminIcon = disp.status_admin_texto === 'Ativo' ? 'fas fa-toggle-on text-green-500' : 'fas fa-toggle-off text-gray-400';
            const statusOperacionalIcon = disp.status_operacional === 'Online' ? 'fas fa-wifi text-green-500' : 'fas fa-ban text-red-500';

            let localizacaoHtml = '';
            if (disp.latitude && disp.longitude) {
                localizacaoHtml = `<span class="ml-1">Lat: ${parseFloat(disp.latitude).toFixed(4)}, Lon: ${parseFloat(disp.longitude).toFixed(4)}</span>`;
            } else {
                localizacaoHtml = `<a href="${disp.url_editar_localizacao}" target="_blank" class="ml-1 text-xs italic text-blue-600 hover:underline hover:text-blue-800 transition-colors duration-150">Adicionar localização</a>`;
            }

            let ultimasLeiturasHtml = '';
            if (disp.ultimas_leituras_detalhadas && disp.ultimas_leituras_detalhadas.length > 0) {
                disp.ultimas_leituras_detalhadas.forEach(leitura => {
                    let iconLeitura = 'fas fa-chart-bar text-gray-400'; // Default
                    if (leitura.nome_original === 'temperature') iconLeitura = 'fas fa-thermometer-half text-red-500';
                    if (leitura.nome_original === 'humidity') iconLeitura = 'fas fa-tint text-blue-500';
                    if (leitura.nome_original === 'waterLevel') iconLeitura = 'fas fa-water text-cyan-500';
                    
                    ultimasLeiturasHtml += `
                        <div class="flex items-start text-xs mt-1">
                            <i class="${iconLeitura} fa-fw w-4 text-center mr-1.5 opacity-75 mt-0.5"></i>
                            <div class="flex-1 min-w-0">
                                <span class="font-medium text-gray-600">${leitura.nome_sensor}:</span>
                                <span class="ml-1">${leitura.valor} ${leitura.unidade_medida || ''}</span>
                                ${leitura.timestamp_dt ? `<span class="ml-1.5 text-gray-500">(${formatTimestampSP(leitura.timestamp_dt)})</span>` : ''}
                            </div>
                        </div>`;
                });
            } else {
                ultimasLeiturasHtml = '<p class="text-xs italic text-gray-500 mt-1">Nenhuma leitura recente.</p>';
            }

            const popupContent = `
                <div class="map-popup-content text-sm text-gray-800" style="min-width: 260px; max-width:320px;">
                    <div class="mb-2">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <h2 class="text-base font-bold text-gray-800 group-hover:text-primary truncate transition-colors duration-300">${disp.nome}</h2>
                                ${statusBadgeHtml}
                            </div>
                            <div class="text-xs text-gray-600 text-right space-y-0.5 flex-shrink-0 ml-2">
                                <p class="flex items-center justify-end whitespace-nowrap" title="Status Administrativo"><i class="${statusAdminIcon} mr-1.5"></i>${disp.status_admin_texto}</p>
                                <p class="flex items-center justify-end whitespace-nowrap" title="Status Operacional"><i class="${statusOperacionalIcon} mr-1.5"></i>${disp.status_operacional}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-1 text-xs text-gray-700 mb-2">
                        <div class="flex items-start">
                            <i class="fas fa-tag fa-fw w-4 text-center mr-2 text-gray-500 mt-0.5"></i>
                            <div class="flex-1 min-w-0"><strong class="font-medium text-gray-600">ID:</strong> <span class="break-all ml-1">${disp.id_dispositivo_fiware}</span></div>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-align-left fa-fw w-4 text-center mr-2 text-gray-500 mt-0.5"></i>
                            <div class="flex-1 min-w-0"><strong class="font-medium text-gray-600">Desc.:</strong> <span class="ml-1 line-clamp-2">${disp.descricao}</span></div>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-map-marker-alt fa-fw w-4 text-center mr-2 text-gray-500 mt-0.5"></i>
                            <div class="flex-1 min-w-0"><strong class="font-medium text-gray-600">Local:</strong> ${localizacaoHtml}</div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-700 mt-2 pt-2 border-t border-gray-200">
                        <h4 class="font-medium text-gray-600 mb-0.5 text-[11px] uppercase">Últimos Registros:</h4>
                        ${ultimasLeiturasHtml}
                    </div>

                    ${disp.url_detalhes !== '#' ? 
                        `<div class="mt-3 pt-2 border-t border-gray-200 text-right">
                            <a href="${disp.url_detalhes}" target="_blank" class="text-xs text-blue-600 hover:text-blue-800 hover:underline font-medium">Ver Detalhes &rarr;</a>
                         </div>` : ''}
                </div>
            `;
            // --- Fim da Construção do HTML do Popup ---

            const leafletMarker = L.marker([disp.latitude, disp.longitude], {icon: markerElement, deviceStatus: disp.status_marcador_code})
                .addTo(map)
                .bindPopup(popupContent);
            
            allMapMarkers.push(leafletMarker);
        });
    }

    function filterMarkersByStatus() {
        const activeStatuses = [];
        document.querySelectorAll('.filter-status:checked').forEach(checkbox => {
            activeStatuses.push(checkbox.value);
        });

        allMapMarkers.forEach(marker => {
            if (activeStatuses.includes(marker.options.deviceStatus)) {
                if (!map.hasLayer(marker)) {
                    map.addLayer(marker);
                }
            } else {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        initMap();
    });
</script>
<style>
    /* Adicionando estilos para os popups de status para garantir visibilidade */
    .status-popup-critical { color: red; font-weight: bold; }
    .status-popup-moderate { color: orange; font-weight: bold; }
    .status-popup-normal { color: green; font-weight: bold; }
    .map-marker {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        color: white;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        border: 2px solid #fff;
        position: relative;
        z-index: 10;
        box-sizing: border-box;
        display: block;
        text-align: center;
        line-height: normal; /* Ajustado para melhor centralização vertical do texto/ícone */
        padding: 0;
        margin: 0;
        /* Remover qualquer transition/transform daqui! */
    }
    .pulse-inner {
        display: inline-block;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        /* Ajustar line-height se o conteúdo do span for só texto e precisar centralizar */
        line-height: inherit; /* Herda do .map-marker que agora tem line-height: normal e é flex */
        text-align: center;
    }
    .critical .pulse-inner {
        background-color: #ff4d4d;
        animation: critical-pulse 1.5s infinite;
    }
    .moderate .pulse-inner {
        background-color: #facc15;
    }
    .normal .pulse-inner {
        background-color: #22c55e;
    }
    @keyframes critical-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255,77,77,0.7); }
        70% { box-shadow: 0 0 0 10px rgba(255,77,77,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,77,77,0); }
    }
    /* Tema dark via CSS para o mapa (DEV.to) */
    .leaflet-tile {
        filter: invert(90%) hue-rotate(180deg);
    }
    .leaflet-container {
        background: #111;
    }
    /* Remove filtro dos controles, marcadores e overlays */
    .leaflet-control,
    .leaflet-marker-icon,
    .leaflet-pane > *:not(.leaflet-tile) {
        filter: none !important;
    }

    .leaflet-popup-pane {
        z-index: 700; 
    }

    .leaflet-control-zoom {
        margin-top: 70px !important; /* Aumentei um pouco para garantir que desça abaixo da navbar de 80px (pt-20) */
        margin-left: 10px !important; /* Adicionado um pequeno recuo da borda */
    }
    @media (min-width: 640px) { /* sm breakpoint do Tailwind, quando a navbar volta a ser flutuante */
        .leaflet-control-zoom {
            margin-top: 10px !important; 
            margin-left: 10px !important; /* Mantém o recuo */
        }
    }
</style>
{% endblock %} 